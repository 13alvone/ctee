#!/usr/bin/env zsh

set -e # Exit on error

# Define directory to save output files
output_dir="$HOME/.ctee/"

# Function to cleanup temp files
function cleanup {
  rm -f "$temp_zshrc"
  rm -rf "$temp_zsh_dir"
}

# Function to delete old ctee sessions
function delete_old_sessions {
  # If the output directory doesn't exist, no need to clean up
  if [[ ! -d "$output_dir" ]]; then
    return 0
  fi
  
  # Use find to delete files in output_dir that were last modified more than 7 days ago
  # -type f ensures we're only looking at files, not directories
  # -mtime +7 matches files that were last modified more than 7 days ago
  # ! -exec fuser -s {} \; matches files that are not currently being written to
  # -exec rm {} \; deletes the matched files
  find "$output_dir" -type f -mtime +7 ! -exec fuser -s {} \; -exec rm {} \;
}

# Register the cleanup function to be called on the EXIT signal
trap cleanup EXIT

# Generate a timestamp for unique filename
timestamp=$(date +%Y%m%d%H%M%S)

# Prompt the user for the recording filename if not provided
if [ -z "$1" ]
then
    filename="cli_record_$timestamp"
else
    filename="$1"
    if [ -f "${output_dir}${filename}" ]; then
        echo "Error: File ${output_dir}${filename} already exists."
        exit 1
    fi
fi

# Check if the 'script' utility is installed and accessible
if ! command -v script &> /dev/null
then
    echo "The 'script' utility could not be found. Please install it and try again."
    exit 1
fi

# Create a temporary directory and zshrc file in it
temp_zsh_dir=$(mktemp -d)
temp_zshrc="$temp_zsh_dir/.zshrc"

# Define the commands to stop recording and change the prompt
echo "PROMPT='CTEE [REC] %_ '" >> "$temp_zshrc"
echo "alias stop_recording='echo Recording Ended; exit'" >> "$temp_zshrc"

# Add optional alias for cspeakes_enumerator. Not default installed, but works if so.
echo "alias target=\"/usr/local/bin/create_target.sh\"" >> "$temp_zshrc"

# Create the target directory if it doesn't already exist
mkdir -p "$output_dir"

# Start recording with the 'script' command
ZDOTDIR="$temp_zsh_dir" script -a "${output_dir}${filename}" -q --command="zsh"

# Delete old sessions
delete_old_sessions

echo "Recording saved in ${output_dir}${filename}"

